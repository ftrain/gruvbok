/**
 * GRUVBOK - Hardware MIDI Groovebox
 *
 * A modular, always-playing musical instrument built on Teensy 4.1
 *
 * Architecture:
 * - Song: Complete data structure (15 modes × 32 patterns × 8 tracks × 16 events)
 * - Sequencer: Playback engine (always looping through data)
 * - Hardware: I/O abstraction (16 buttons, 4 pots, LED)
 * - MIDIScheduler: Delta-time MIDI event scheduling
 * - Modes: Musical interpreters (drum machine, acid sequencer, etc.)
 *
 * Memory usage: ~240KB for song data + overhead
 */

#include <Arduino.h>
#include "core/Song.h"
#include "core/DefaultSongs.h"
#include "hardware/Hardware.h"
#include "sequencer/Sequencer.h"
#include "sequencer/MIDIScheduler.h"

// Global instances
Song song;
Hardware hardware;
MIDIScheduler scheduler;
Sequencer sequencer(&song, &hardware, &scheduler);

void setup() {
  // Initialize hardware
  hardware.init();

  // Load default demo song (plays immediately on power-up!)
  DefaultSongs::loadDemoSong(song);

  // Initialize sequencer and modes
  sequencer.init();

  // Set default tempo (can be changed with pot 0)
  sequencer.setBPM(120.0);

  // Start playback immediately
  sequencer.start();

  // Blink LED to indicate ready
  for (int i = 0; i < 3; i++) {
    hardware.setLED(true);
    delay(100);
    hardware.setLED(false);
    delay(100);
  }
}

void loop() {
  // Main update - handles everything:
  // - User input (buttons/pots)
  // - Step advancement
  // - Event processing
  // - MIDI scheduling and output
  // - MIDI clock
  sequencer.update();
}
